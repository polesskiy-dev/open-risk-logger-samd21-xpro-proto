name: ci

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the main branch
on:
  push:
    branches:
      [ main ]
  workflow_dispatch:

jobs:
  deploy-doxygen:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository and submodules
        uses: actions/checkout@v3
        with:
          submodules: recursive
      # Build the HTML documentation
      - name: Doxygen Action
        run: |
          sudo apt-get install -y doxygen
          doxygen Doxyfile

      # Deploy the HTML documentation to GitHub Pages
      - name: GH Pages Deployment
        uses: peaceiris/actions-gh-pages@v3 # https://github.com/peaceiris/actions-gh-pages
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./html #deploy ./html directory to the remote gh-pages branch.
          enable_jekyll: false
          allow_empty_commit: false
          force_orphan: true
          publish_branch: gh-pages
  # Check XC32 compilation
  compile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          submodules: recursive
      - name: Download Microchip XC32 Compiler
        run: wget https://ww1.microchip.com/downloads/aemDocuments/documents/DEV/ProductDocuments/SoftwareTools/xc32-v4.30-full-install-linux-x64-installer.tar
      - name: Extract & Install Microchip XC32 Compiler
        run: tar -xf xc32-v4.30-full-install-linux-x64-installer.tar
      - run: chmod a+x xc32-v4.30-full-install-linux-x64-installer.run
      - run: sudo ./xc32-v4.30-full-install-linux-x64-installer.run --mode unattended --debuglevel 4 --netservername localhost --LicenseType FreeMode # --installdir /Applications/microchip/xc32/v4.30/bin/
      - run: ls -al /opt/microchip/xc32/v4.30/bin
      - name: Replace Makefile-local-default.mk by CI related
        run: mv ./config/Makefile-ci-default.mk ./firmware/open-risk-logger-samd21-xpro-proto.X/nbproject/Makefile-local-default.mk
      - name: Compile project Makefile
        run: cd ./firmware/open-risk-logger-samd21-xpro-proto.X && make